version: '3.8'

services:
  # 1. データベース (Keycloak用)
  postgres:
    image: postgres:15
    container_name: keycloak_postgres
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - keycloak-net

  # 2. Keycloak (IdP)
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      # DB設定
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      # ▼▼▼ 追加・修正箇所 ▼▼▼
      # Keycloakの公開URLを固定し、発行者(iss)を "http://localhost:8080..." に統一する
      KC_HOSTNAME_URL: http://localhost:8080
      # コンテナ間通信(http://keycloak:8080)でのアクセスも許可するため、Strictモードを無効化
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_BACKCHANNEL: "false"
      # ▲▲▲ 追加・修正箇所 ▲▲▲
      KC_LOG_LEVEL: DEBUG
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - keycloak-net

  # 3. API Server (Resource Server)
  api:
    build: ./api
    container_name: python_api
    ports:
      - "5000:5000"
    environment:
      # コンテナ内からKeycloakへの通信URL
      KEYCLOAK_URL: "http://keycloak:8080"
      REALM_NAME: "demo-realm"
      CLIENT_ID: "demo-client"
      # 【重要】Keycloak設定後に書き換える箇所
      CLIENT_SECRET: "CHANGE_ME_AFTER_SETUP"
    depends_on:
      - keycloak
    networks:
      - keycloak-net

networks:
  keycloak-net:
    driver: bridge